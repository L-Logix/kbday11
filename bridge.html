<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bridge/Cockpit Navigation</title>
<style>
body {
  background: #0b0c0f;
  color: #00ff99;
  font-family: 'Orbitron', monospace;
  margin: 0;
  text-align: center;
  overflow: hidden;
}
h1 {
  margin: 20px 0;
  text-shadow: 0 0 10px #00ff99;
}
canvas {
  background: #11181f;
  border: 3px solid #00ff99;
  display: block;
  margin: 0 auto;
  touch-action: none;
}
#status { margin-top: 10px; font-size: 1.2rem; font-weight: bold; }
#timer { margin-top: 10px; font-size: 1rem; }
.controls {
  margin-top: 10px;
}
button {
  background: #11181f;
  border: 3px solid #00ff99;
  border-radius: 10px;
  color: #00ff99;
  font-weight: bold;
  font-size: 1.2rem;
  padding: 15px 25px;
  margin: 5px;
  cursor: pointer;
}
button:active { background: #00ff99; color: #0b0c0f; }
button:disabled { border-color: #555; color: #555; }
</style>
</head>
<body>
<h1>Bridge/Cockpit Navigation</h1>
<canvas id="gameCanvas" width="500" height="600"></canvas>
<div id="status">Use controls to navigate</div>
<div id="timer">Time: 45</div>
<div class="controls">
  <button id="leftBtn">← Left</button>
  <button id="boostBtn">↑ Boost</button>
  <button id="rightBtn">→ Right</button>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwCJEfr5PJguOJ79eDjA3QSiK-qe01gMIqCTTKLtjOst4bsavkNMQSx01QThXejm3UU/exec';
const challengeIndex = 8; // Bridge/Cockpit

// Check if already ON
async function checkCompleted() {
  try {
    const res = await fetch(API_URL);
    const statuses = await res.json();
    if(statuses[challengeIndex] === 'ON'){
      document.getElementById('status').textContent = 'Already completed ✅';
      disableControls();
      clearInterval(gameInterval);
      clearInterval(asteroidInterval);
      clearInterval(timerInterval);
    }
  } catch(e){ console.error(e); }
}

// Canvas setup
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const gridCols = 5;
const cellWidth = canvas.width / gridCols;
const shipHeight = 30;
const shipWidth = 40;

let shipCol = 2;
let shipRow = canvas.height - shipHeight;
let asteroids = [];
let gameInterval, asteroidInterval, timerInterval;
let timeLeft = 45;
let isPlaying = true;
let penalty = false;

// Draw ship and asteroids
function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // Ship
  ctx.fillStyle = '#00ff99';
  ctx.fillRect(shipCol*cellWidth + cellWidth/2 - shipWidth/2, shipRow, shipWidth, shipHeight);
  // Asteroids
  ctx.fillStyle = '#ff3b3b';
  asteroids.forEach(a => {
    ctx.beginPath();
    ctx.arc(a.x, a.y + 15, 15, 0, Math.PI*2);
    ctx.fill();
  });
}

// Update positions
function update() {
  if(!isPlaying) return;

  let hit = false;
  asteroids.forEach(a => {
    a.y += a.speed;
    if(a.y + 30 > shipRow && a.y < shipRow + shipHeight && a.col === shipCol){
      hit = true;
    }
  });

  if(hit){
    isPlaying = false;
    document.getElementById('status').textContent = 'Hit! 5-second penalty';
    disableControls();
    setTimeout(()=>{
      resetShip();
      isPlaying = true;
      enableControls();
      document.getElementById('status').textContent = 'Use controls to navigate';
    },5000);
  }

  if(shipRow <= 0){
    isPlaying = false;
    document.getElementById('status').textContent = 'Navigation Complete! ✅';
    fetch(`${API_URL}?index=${challengeIndex}&status=ON`,{method:'POST'});
    disableControls();
    clearInterval(timerInterval);
  }

  draw();
}

// Reset ship
function resetShip(){
  shipCol = 2;
  shipRow = canvas.height - shipHeight;
}

// Timer
timerInterval = setInterval(()=>{
  if(isPlaying && !penalty){
    timeLeft--;
    document.getElementById('timer').textContent = 'Time: '+timeLeft;
    if(timeLeft<=0){
      isPlaying=false;
      document.getElementById('status').textContent='Time up! Restart challenge.';
      disableControls();
    }
  }
},1000);

// Create asteroids
function createAsteroid(){
  const col = Math.floor(Math.random()*gridCols);
  asteroids.push({col,x:col*cellWidth + cellWidth/2, y:-30, speed:Math.random()*2 + 2});
}

// Controls
const leftBtn = document.getElementById('leftBtn');
const rightBtn = document.getElementById('rightBtn');
const boostBtn = document.getElementById('boostBtn');

function disableControls(){ leftBtn.disabled = rightBtn.disabled = boostBtn.disabled = true; }
function enableControls(){ leftBtn.disabled = rightBtn.disabled = boostBtn.disabled = false; }

leftBtn.addEventListener('click',()=>{ if(shipCol>0) shipCol--; });
rightBtn.addEventListener('click',()=>{ if(shipCol<gridCols-1) shipCol++; });
boostBtn.addEventListener('click',()=>{ shipRow -= 50; if(shipRow<0) shipRow=0; });

// Game loop
gameInterval = setInterval(update,30);
asteroidInterval = setInterval(createAsteroid,800);

// Check completion on load
checkCompleted();
</script>
</body>
</html>
