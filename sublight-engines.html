<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <title>Sublight Engines Challenge</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap');

    body {
      background: #0b0c0f;
      color: #00ff99;
      font-family: 'Orbitron', sans-serif;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 20px;
      user-select: none;
    }

    h1 {
      font-weight: 700;
      letter-spacing: 0.15em;
      text-shadow: 0 0 10px #00ff99, 0 0 20px #00ff99;
      margin-bottom: 10px;
      text-align: center;
    }

    #status {
      margin-bottom: 20px;
      font-size: 1.2rem;
      font-weight: 700;
      color: #0f0;
      text-shadow: 0 0 8px #0f0;
      height: 28px;
    }

    #cards {
      display: flex;
      flex-wrap: wrap;
      width: 500px;
      justify-content: center;
      gap: 15px;
    }

    .card {
      position: relative;
      width: 90px;
      height: 120px;
      perspective: 800px;
      cursor: pointer;
    }

    .inner-card {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }

    .flipped .inner-card {
      transform: rotateY(180deg);
    }

    .front, .back {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 15px;
      backface-visibility: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      font-weight: 900;
      box-shadow: 0 0 10px #700000, inset 0 0 20px #500000;
      user-select: none;
    }

    .front {
      background: #700000;
      color: #ff3b3b;
      box-shadow:
        inset 0 0 20px #7f0000,
        0 0 20px #ff3b3b;
    }

    .back {
      background: #11181f;
      color: #00ff99;
      font-size: 1.8rem;
      flex-direction: column;
      padding: 10px;
      box-shadow:
        inset 0 0 20px #007f44,
        0 0 20px #00ff99;
      transform: rotateY(180deg);
    }

    .back input[type="text"] {
      width: 60px;
      font-size: 2rem;
      border: none;
      border-radius: 8px;
      padding: 5px;
      text-align: center;
      background: #222;
      color: #00ff99;
      box-shadow: inset 0 0 5px #00ff99;
      user-select: text;
    }

    .back button {
      margin-top: 10px;
      font-size: 1rem;
      font-weight: 700;
      background: #00ff99;
      color: #0b0c0f;
      border: none;
      border-radius: 10px;
      padding: 5px 12px;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s ease;
    }

    .back button:hover:not(:disabled) {
      background: #33ffbb;
    }

    .back button:disabled {
      background: #444;
      cursor: not-allowed;
    }

    #resetBtn {
      margin-top: 25px;
      font-size: 1.2rem;
      font-weight: 700;
      background: #ff3b3b;
      color: #0b0c0f;
      border: none;
      border-radius: 15px;
      padding: 10px 20px;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s ease;
    }

    #resetBtn:hover {
      background: #ff6666;
    }

    /* Success message */
    #completedMessage {
      margin-top: 20px;
      font-size: 1.4rem;
      font-weight: 700;
      color: #0f0;
      text-shadow: 0 0 12px #0f0;
    }
  </style>
</head>
<body>
  <h1>Sublight Engines Challenge</h1>
  <div id="status"></div>
  <div id="cards"></div>
  <button id="resetBtn">Reset Progress</button>
  <div id="completedMessage"></div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwCJEfr5PJguOJ79eDjA3QSiK-qe01gMIqCTTKLtjOst4bsavkNMQSx01QThXejm3UU/exec';
    const cardsContainer = document.getElementById('cards');
    const statusDiv = document.getElementById('status');
    const resetBtn = document.getElementById('resetBtn');
    const completedMessage = document.getElementById('completedMessage');

    const correctLetters = ['G', 'R', 'E', 'L', 'Q', 'B', 'a', 'P', 'S', 'F'];

    let cardStates = [];

    function countCorrect() {
      return cardStates.filter(c => c.correct).length;
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function createCards() {
      cardsContainer.innerHTML = '';
      cardStates = [];
      let indices = [...Array(10).keys()];
      shuffle(indices);

      for (let i = 0; i < 10; i++) {
        const idx = indices[i];
        cardStates[idx] = { attempts: 0, correct: false };

        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.idx = idx;

        const inner = document.createElement('div');
        inner.className = 'inner-card';

        const front = document.createElement('div');
        front.className = 'front';
        front.textContent = (idx + 1);

        const back = document.createElement('div');
        back.className = 'back';

        const input = document.createElement('input');
        input.type = 'text';
        input.maxLength = 1;
        input.placeholder = 'Letter';

        const submitBtn = document.createElement('button');
        submitBtn.textContent = 'Submit';

        back.appendChild(input);
        back.appendChild(submitBtn);

        inner.appendChild(front);
        inner.appendChild(back);
        card.appendChild(inner);

        cardsContainer.appendChild(card);

        card.addEventListener('click', () => {
          if (cardStates[idx].correct) return;
          card.classList.toggle('flipped');
          if (card.classList.contains('flipped')) {
            input.focus();
          }
        });

        back.addEventListener('click', e => e.stopPropagation());

        submitBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          checkAnswer(idx, input.value.trim().toUpperCase(), card, input);
        });

        input.addEventListener('keydown', e => {
          if (e.key === 'Enter') {
            e.preventDefault();
            submitBtn.click();
          }
        });
      }
    }

   function checkAnswer(idx, letter, card, input) {
  // Allow both lowercase and uppercase inputs
  if (!letter.match(/^[A-Za-z]$/)) {
    alert('Please enter a valid single letter A-Z');
    input.value = '';
    input.focus();
    return;
  }

  if (cardStates[idx].correct) return;

  // Special rule: Fuel Cell 7 requires lowercase 'a'
  if ((idx === 6 && letter === 'a') || (idx !== 6 && letter.toUpperCase() === correctLetters[idx])) {
    cardStates[idx].correct = true;
    card.classList.remove('flipped');
    const front = card.querySelector('.front');
    front.style.background = '#007f44';
    front.style.color = '#0f0';
    front.style.boxShadow = 'inset 0 0 20px #0f7000, 0 0 20px #0f0';
    updateStatusText();
    checkCompletion();
  } else {
    cardStates[idx].attempts++;
    if (cardStates[idx].attempts >= 5) {
      alert('5 incorrect attempts on this card - Progress reset!');
      resetProgress();
    } else {
      alert(`Incorrect! Attempts left: ${5 - cardStates[idx].attempts}`);
    }
    input.value = '';
    input.focus();
  }
}


    function updateStatusText() {
      const correctCount = countCorrect();
      statusDiv.textContent = `Fuel Cells Activated: ${correctCount} / 10`;
    }

    function resetProgress() {
      cardStates = cardStates.map(() => ({ attempts: 0, correct: false }));
      createCards();
      updateStatusText();
      completedMessage.textContent = '';
    }

    function checkCompletion() {
      if (countCorrect() === 10) {
        completedMessage.textContent = 'All Fuel Cells Activated! Sublight Engines Online!';
        setLight(0, 'ON');  // index 0 for Light 1
        disableChallenge();
      }
    }

    function disableChallenge() {
      cardsContainer.style.pointerEvents = 'none';
      resetBtn.disabled = true;
      statusDiv.textContent = 'Sublight Engines are ONLINE!';
      statusDiv.style.color = '#0f0';
      statusDiv.style.textShadow = '0 0 15px #0f0';
    }

    async function fetchStatus() {
      try {
        const res = await fetch(API_URL);
        const statuses = await res.json();
        if (statuses[0] === 'ON') {
          disableChallenge();
        } else {
          updateStatusText();
        }
      } catch (e) {
        console.error('Failed to fetch status:', e);
        statusDiv.textContent = 'Error loading status... Try refreshing.';
      }
    }

    // Your provided POST style using query params and POST method:
    async function setLight(index, status) {
      try {
        await fetch(`${API_URL}?index=${index}&status=${status}`, {
          method: 'POST',
        });
      } catch (e) {
        console.error("Failed to update light:", e);
        alert('Failed to update server status. Check your connection.');
      }
    }

    resetBtn.addEventListener('click', () => {
      if(confirm('Are you sure you want to reset your progress?')) {
        resetProgress();
      }
    });

    createCards();
    fetchStatus();

  </script>
</body>
</html>
