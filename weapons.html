<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Weapons Challenge - Rapid Fire</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap');

  body {
    background: #0b0c0f;
    color: #00ff99;
    font-family: 'Orbitron', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    margin: 0;
  }

  h1 {
    text-align: center;
    margin-bottom: 20px;
    text-shadow: 0 0 10px #00ff99, 0 0 20px #00ff99;
  }

  #threat {
    font-size: 1.5rem;
    margin: 20px;
  }

  .weapons-container {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 20px;
  }

  button.weapon {
    background: #11181f;
    color: #00ff99;
    border: 3px solid #00ff99;
    border-radius: 15px;
    padding: 15px 25px;
    font-size: 1rem;
    cursor: pointer;
    font-weight: bold;
    text-align: center;
    transition: all 0.3s ease;
  }

  button.weapon:hover {
    background: #00ff99;
    color: #0b0c0f;
  }

  button.correct {
    background: #0f0;
    color: #000;
  }

  button.wrong {
    background: #f00;
    color: #000;
  }

  #timer {
    font-size: 1.2rem;
    margin-bottom: 15px;
  }

  #feedback {
    font-size: 1rem;
    margin-top: 10px;
    min-height: 20px;
  }

  #retryBtn {
    background: #11181f;
    color: #00ff99;
    border: 3px solid #00ff99;
    border-radius: 15px;
    padding: 10px 20px;
    cursor: pointer;
    font-weight: bold;
    font-size: 1rem;
    display: none;
    margin-top: 20px;
  }

  #retryBtn:hover {
    background: #00ff99;
    color: #0b0c0f;
  }
</style>
</head>
<body>

<h1>Weapons Challenge</h1>
<div id="timer">Time Left: 10s</div>
<div id="threat">Incoming Threat: ---</div>
<div class="weapons-container" id="weaponsContainer">
  <button class="weapon" id="weapon1"></button>
  <button class="weapon" id="weapon2"></button>
  <button class="weapon" id="weapon3"></button>
</div>
<div id="feedback"></div>
<button id="retryBtn">Retry Challenge</button>

<script>
const threats = [
  {name:"Scout Drone", correct:"Laser", options:["Laser","Missile","EMP"]},
  {name:"Enemy Fighter", correct:"Missile", options:["Laser","Missile","EMP"]},
  {name:"Stealth Ship", correct:"EMP", options:["Laser","Missile","EMP"]},
  {name:"Assault Frigate", correct:"Missile", options:["Laser","Missile","EMP"]},
  {name:"Kamikaze Drone", correct:"Laser", options:["Laser","Missile","EMP"]}
];

let currentThreat = 0;
let correctCount = 0;
let wrongCount = 0;
let timer = 10;
let interval;
let waiting = false;

const API_URL = 'https://script.google.com/macros/s/AKfycbwCJEfr5PJguOJ79eDjA3QSiK-qe01gMIqCTTKLtjOst4bsavkNMQSx01QThXejm3UU/exec';
const indexWeapons = 6; // dashboard index for weapons

const threatEl = document.getElementById('threat');
const timerEl = document.getElementById('timer');
const feedbackEl = document.getElementById('feedback');
const weaponsContainer = document.getElementById('weaponsContainer');
const weapons = [
  document.getElementById('weapon1'),
  document.getElementById('weapon2'),
  document.getElementById('weapon3')
];
const retryBtn = document.getElementById('retryBtn');

function loadThreat() {
  if(currentThreat >= threats.length){
    weaponsContainer.style.display = 'none';
    timerEl.textContent = "";
    feedbackEl.textContent = `You neutralized ${correctCount} correct and ${wrongCount} wrong threats.`;
    if(correctCount === threats.length){
      // Only turn on dashboard light if all correct
      fetch(`${API_URL}?index=${indexWeapons}&status=ON`, { method: "POST" })
        .catch(err => console.error('Failed to update sheet:', err));
    } else {
      retryBtn.style.display = 'block';
    }
    clearInterval(interval);
    return;
  }

  const t = threats[currentThreat];
  threatEl.textContent = "Incoming Threat: " + t.name;
  for(let i=0; i<3; i++){
    weapons[i].textContent = t.options[i];
    weapons[i].className = "weapon";
    weapons[i].disabled = false;
  }
  feedbackEl.textContent = "";
  timer = 10;
  timerEl.textContent = "Time Left: " + timer + "s";
  interval = setInterval(countdown,1000);
}

function countdown(){
  if(timer > 0){
    timer--;
    timerEl.textContent = "Time Left: " + timer + "s";
  } else {
    clearInterval(interval);
    wrongCount++;
    feedbackEl.textContent = "Too slow! 5 second penalty.";
    weapons.forEach(w => w.disabled = true);
    waiting = true;
    let penalty = 5;
    timerEl.textContent = `Penalty: ${penalty}s`;
    const penaltyInterval = setInterval(()=>{
      penalty--;
      timerEl.textContent = `Penalty: ${penalty}s`;
      if(penalty <= 0){
        clearInterval(penaltyInterval);
        waiting = false;
        currentThreat++;
        loadThreat();
      }
    },1000);
  }
}

function handleClick(e){
  if(waiting) return;
  const t = threats[currentThreat];
  if(e.target.textContent === t.correct){
    e.target.classList.add('correct');
    clearInterval(interval);
    feedbackEl.textContent = "Correct! Threat neutralized!";
    weapons.forEach(w => w.disabled = true);

    // Update Google Sheet for weapons challenge (index=6) only if all correct at end
    correctCount++;
    setTimeout(()=>{
      currentThreat++;
      loadThreat();
    },1500);
  } else {
    e.target.classList.add('wrong');
    clearInterval(interval);
    feedbackEl.textContent = "Wrong weapon! 5 second penalty.";
    weapons.forEach(w => w.disabled = true);
    waiting = true;

    wrongCount++;
    let penalty = 5;
    timerEl.textContent = `Penalty: ${penalty}s`;
    const penaltyInterval = setInterval(()=>{
      penalty--;
      timerEl.textContent = `Penalty: ${penalty}s`;
      if(penalty <= 0){
        clearInterval(penaltyInterval);
        waiting = false;
        currentThreat++;
        loadThreat();
      }
    },1000);
  }
}

weapons.forEach(w => w.addEventListener('click', handleClick));

retryBtn.addEventListener('click', ()=>{
  retryBtn.style.display = 'none';
  weaponsContainer.style.display = 'flex';
  currentThreat = 0;
  correctCount = 0;
  wrongCount = 0;
  loadThreat();
});

loadThreat();
</script>
</body>
</html>
